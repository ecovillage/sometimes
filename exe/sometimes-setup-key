#!/usr/bin/env ruby

require 'sometimes'

require 'shellwords'

optparse, options = Sometimes::CLI::Common.option_parser
optparse.parse!

# TODO move this into the boilerplate
if !options[:conf_file] && !ARGV[0]
  STDERR.puts "Need to specify definition file (-c or as argument)."
  exit 1
end
if options[:conf_file] && ARGV[0]
  STDERR.puts "Need to specify only one definition file (-c OR as argument)."
  exit 1
end

definition_file = options[:conf_file] || ARGV[0]

definition = Sometimes::read_def definition_file
key_path   = File.expand_path definition.key

shescape = lambda {|v| Shellwords.escape v}
command = "ssh-keygen -q -N '' -C '%s' -f %s" % [definition.comment,
                                                 key_path].map(&shescape)

# Create the key-pair
Sometimes::Shell.execute(command)
if $?.exitstatus != 0
  STDERR.puts "Key creation failed with exit #{$?.exitstatus}."
  exit 1
end

# Create authorized_keys file entry
what_path = File.expand_path definition.what
pub_key   = File.read(key_path + ".pub")
authorized_keys = Sometimes::AuthorizedKeysFile.line definition

# TODO sanity check, result check
File.open(key_path + ".authorized_keys.command", 'w') {|f| f.write(authorized_keys) }

# Explicit, graceful exit
exit 0
