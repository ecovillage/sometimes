#!/usr/bin/env ruby

require 'sometimes'

require 'date'

optparse, options = Sometimes::CLI::Common.option_parser ""\
  "Runs a backup and shuffles files around as indicated by the definition file."
optparse.parse!

Sometimes::EnvironmentCheck.check!

definition = Sometimes::CLI::Common.load_definition options
Sometimes::FileEnvironment.prepare! definition

now = DateTime.now

# Pseudo-schedule (TODO)
if now.day == 1
  scheme = :monthly
elsif now.wday == 0 # sunday
  scheme = :weekly
else
  scheme = :daily
end

Sometimes::StoreCleaner.clean! definition, scheme

store_path = "#{definition.path}/#{scheme.to_s}"
file_extension = Sometimes::FileEnvironment.file_extension(definition)
now_relpath = "#{store_path}/#{now.strftime('%F_%H%M')}.#{file_extension}"

ssh_command = "ssh -i #{definition.key} #{definition.user}@#{definition.host} > #{now_relpath}"
Sometimes::Shell.execute(ssh_command)

# Link it. TODO: Absolute paths
last_file_link_path = "#{definition.path}/last.#{file_extension}"
Sometimes::Shell.execute("rm #{last_file_link_path}")
Sometimes::Shell.execute("ln -s #{now_relpath} #{last_file_link_path}")

# Exit gracefully
exit 0
